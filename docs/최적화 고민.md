### READ / WRITE

- READ 와 WRITE 성능을 고려해야함
    - 공연 정보를 캐싱하여 조회 성능을 높일 수 있음
    - 좌석 정보의 경우에는 인기 아티스트의 경우 정보가 빠르게 바뀌기 때문에 실시간으로 갱신할 수 있어야 함
    - 인기 아티스트의 경우에는 예매 요청이 증가하여 쓰기 연산이 증가할 수 있음
        - 예매 요청을 받는 서버와 예약 및 결제를 처리하는 서버로 나눠 메세지 큐를 이용한 부하 분산을 고려


### 동시성 처리

- 다수의 사용자가 동시에 예매를 요청했을 때, 순서를 적절히 처리하지 않으면 race condition 발생
    - ex) 좌석의 재고가 100석인 경우
      → 10명의 사용자가 동시에 예매 요청
      → 사용자가 동시에 읽을 때는 재고가 100석임
      → 예매 성공 후 남은 좌석은 90석 아니라 99석이 될 수 있음
- 동시성 처리 방법
    - Java synchronized 키워드
        - 메소드 레벨에 synchronized 키워드를 통해 동시성 보장
        - 락의 범위가 어플리케이션 단위이기 때문에 서버가 분산환경인 경우에는 동시성을 보장할 수 없음
    - 낙관적 락
        - Verisoning을 통해 동시성을 보장
        - 충돌이 발생하면 클라이언트가 재시도하여 충돌이 잦은 경우에는 부하가 발생할 수 있음
    - 비관적 락
        - 데이터베이스 수준에서 락을 잡아 데이터에 접근하기 전에 미리 락을 거는 방식
        - 락을 획득한 경우에만 작업을 진행할 수 있음
        - 충돌이 많이 발생할 경우에 낙관적 락에 비해 유리함
    - Redis 분산락
        - 비관적 락에 비해 보다 유연하게 락 전략을 적용할 수 있음(락의 범위나 시간 등)

### 테이블 설계

- 공연장은 좌석을 여러 개 가지고 있는데, 좌석 정보를 어떻게 설계할지
    - 좌석이 필요한 정보
        - 좌석 번호
        - 예약 가능 여부
        - 좌석 타입(NORMAL, VIP)
        - 예약 테이블의 기본키(외래키)
        - 공연장 테이블의 기본키(외래키)
    - 가능한 방법
        - 공연장 테이블에 문자열 컬럼으로 좌석의 정보를 관리
          (seats = “A1O,B1O,C1O” 와 같은 패턴)
        - 좌석 테이블 정규화
    - 좌석이 가져야 하는 정보가 많아 문자열 컬럼 관리는 구현이 복잡할 것이라 판단하여 좌석 테이블을 정규화 하는 방식을 채택

- 결제 테이블이 필요한 외래키가 있을지
    - 결제 테이블의 고정 정보
        - card_cvv
        - card_expiration
        - card_number
        - payment_method
    - 결제 테이블을 통해서 조회가 필요한 정보가 있을지 생각

- 결제 데이터 재사용 vs 예약 요청 마다 결제 데이터 생성
    - 재사용 하는 경우
        - 예약 테이블과 결제 테이블이 다대일 관계를 가짐
    - 요청 마다 결제 데이터 생성하는 경우
        - 예약 테이블과 결제 테이블이 일대일 관계를 가짐
    - 리소스를 최소화 하기 위해 재사용 하는 방식으로 구현
        - 후에 구현에 어려움이 있으면 재사용 하지 않도록 수정

### 부하 분산 설계

- 인기 아티스트의 경우 트래픽이 커질 수 있어 부하 분산을 고려해야함
- 공연 예매 플로우
    1. 공연 조회
    2. 공연 좌석 조회
    3. 좌석 선택 후 예약 및 결제 요청
    4. 예약 및 결제 완료
- 예약 요청을 처리하는 서버 와 결제를 처리하는 서버로 분할 고려
    - 예약 요청을 정상적으로 처리 했다면 메세지 큐를 통해 결제 서버에게 알림
    - 결제 서버에서 예약 요청을 시간순으로 조회하여 결제를 처리하도록 함
    - 사용자는 예약 완료 응답을 내리고 결제 처리 상태를 확인할 수 있게함
    - 결제 서버에서 결제가 정상적으로 처리 된다면 결제 처리 상태를 완료로 수정
- 결제 서버에서 에러가 난다면?
    - 사용자에게 예약이 실패했다는 알림과 트랜잭션 롤백을 위해 사가 패턴을 적용해서 예약 요청 처리 서버에게 메세지를 보내 예약을 삭제하도록 요청